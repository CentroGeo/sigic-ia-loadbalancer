env OIDC_CONFIG_URL;

events { 
  worker_connections 1024; 
}

http {
  resolver 127.0.0.53 valid=30s;
  resolver_timeout 10s;
  
  lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
  lua_ssl_verify_depth 3;
  lua_ssl_protocols TLSv1.2 TLSv1.3;
  
  # lua_socket_connect_timeout 30s;
  # lua_socket_send_timeout 30s;
  # lua_socket_read_timeout 30s;

  lua_package_path "/usr/local/openresty/lualib/?.lua;;";

  upstream ia-engine {
    server ia-engine:8000;
    # server 10.2.5.3:8001;
    # server 10.2.5.5:8001;
  }
  
  map $http_authorization $http_authorization_upstream {
    default $http_authorization;
    ""      "";
  }
  
  
  upstream ia-queue {
    server ia-queue:8000;
  }
  
  server {
    listen 80;
    client_max_body_size 50G;

    location ~ ^/llmb/api/schema/(.*)$ {
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }
      
      #access_by_lua_file /usr/local/openresty/lualib/auth.lua;
      rewrite ^/(.*)$ /$1 break;
      proxy_pass http://ia-engine;
      
      # Pasa el token de Keycloak (solo si existe) y cookies de sesión
      proxy_set_header   Authorization        $http_authorization_upstream;
      proxy_set_header   Cookie               $http_cookie;
	  

      # Host/cliente/esquema reales (necesario para Django)
      proxy_set_header   Host                 $host;
      proxy_set_header   X-Forwarded-Host     $host;
      proxy_set_header   X-Forwarded-Proto    $scheme;
      proxy_set_header   X-Forwarded-Port     $server_port;
      proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
      proxy_set_header   X-Real-IP            $remote_addr;

      

      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      #Tiempo de conexion
      proxy_connect_timeout 5s;
      proxy_read_timeout 300s;
      proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
      proxy_intercept_errors on;

    }

    location ~ ^/llmb/apidocs/(.*)$ {
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }
      
      #access_by_lua_file /usr/local/openresty/lualib/auth.lua;
      rewrite ^/(.*)$ /$1 break;
      proxy_pass http://ia-queue;
      
      # Pasa el token de Keycloak (solo si existe) y cookies de sesión
      proxy_set_header   Authorization        $http_authorization_upstream;
      proxy_set_header   Cookie               $http_cookie;
	  

      # Host/cliente/esquema reales (necesario para Django)
      proxy_set_header   Host                 $host;
      proxy_set_header   X-Forwarded-Host     $host;
      proxy_set_header   X-Forwarded-Proto    $scheme;
      proxy_set_header   X-Forwarded-Port     $server_port;
      proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
      proxy_set_header   X-Real-IP            $remote_addr;

      

      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      #Tiempo de conexion
      proxy_connect_timeout 5s;
      proxy_read_timeout 300s;
      proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
      proxy_intercept_errors on;

    }

    location ~ ^/llmb/flasgger_static/(.*)$ {
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }
      
      #access_by_lua_file /usr/local/openresty/lualib/auth.lua;
      rewrite ^/(.*)$ /$1 break;
      proxy_pass http://ia-queue;
      
      # Pasa el token de Keycloak (solo si existe) y cookies de sesión
      proxy_set_header   Authorization        $http_authorization_upstream;
      proxy_set_header   Cookie               $http_cookie;
	  

      # Host/cliente/esquema reales (necesario para Django)
      proxy_set_header   Host                 $host;
      proxy_set_header   X-Forwarded-Host     $host;
      proxy_set_header   X-Forwarded-Proto    $scheme;
      proxy_set_header   X-Forwarded-Port     $server_port;
      proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
      proxy_set_header   X-Real-IP            $remote_addr;

      

      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      #Tiempo de conexion
      proxy_connect_timeout 5s;
      proxy_read_timeout 300s;
      proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
      proxy_intercept_errors on;

    }

    location ~ ^/llmb/apispec_1.json(.*)$ {
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }
      
      #access_by_lua_file /usr/local/openresty/lualib/auth.lua;
      rewrite ^/(.*)$ /$1 break;
      proxy_pass http://ia-queue;
      
      # Pasa el token de Keycloak (solo si existe) y cookies de sesión
      proxy_set_header   Authorization        $http_authorization_upstream;
      proxy_set_header   Cookie               $http_cookie;
	  

      # Host/cliente/esquema reales (necesario para Django)
      proxy_set_header   Host                 $host;
      proxy_set_header   X-Forwarded-Host     $host;
      proxy_set_header   X-Forwarded-Proto    $scheme;
      proxy_set_header   X-Forwarded-Port     $server_port;
      proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
      proxy_set_header   X-Real-IP            $remote_addr;

      

      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      #Tiempo de conexion
      proxy_connect_timeout 5s;
      proxy_read_timeout 300s;
      proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
      proxy_intercept_errors on;

    }

    location ~ ^/llmb/(.*)$ {
      if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }

      access_by_lua_file /usr/local/openresty/lualib/auth.lua;
      
      rewrite ^/llmb/(.*)$ /$1 break;
      proxy_pass http://ia-engine;
	  
      # Pasa el token de Keycloak (solo si existe) y cookies de sesión
      proxy_set_header   Authorization        $http_authorization_upstream;
      proxy_set_header   Cookie               $http_cookie;
	  

      # Host/cliente/esquema reales (necesario para Django)
      proxy_set_header   Host                 $host;
      proxy_set_header   X-Forwarded-Host     $host;
      proxy_set_header   X-Forwarded-Proto    $scheme;
      proxy_set_header   X-Forwarded-Port     $server_port;
      proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
      proxy_set_header   X-Real-IP            $remote_addr;


      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      
      #Tiempo de conexion
      proxy_connect_timeout 5s;

      #Tiempo de espera del servidor
      proxy_read_timeout 300s;

      #respuesta en caso de error
      proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;

      #intento total por servidores en este caso no llega al 10.2.5.5
      #proxy_next_upstream_tries 3;

      proxy_intercept_errors on;
    }

    location ~ ^/(.*)$ {
      return 404;
    }

  }
} 